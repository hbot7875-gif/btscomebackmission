name: âš¡ BTS Mission Hourly Sync

on:
  schedule:
    - cron: '0 * * * *'
  
  workflow_dispatch:
    inputs:
      week:
        description: 'Week label (leave empty for auto-detect)'
        required: false
        default: ''
      total_shards:
        description: 'Number of shards'
        required: false
        default: '5'

env:
  EDGE_FUNCTION_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  SYNC_ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}

jobs:

  pre-sync:
    name: ğŸ” Pre-Sync Check
    runs-on: ubuntu-latest
    outputs:
      current_week: ${{ steps.check.outputs.week }}
      total_shards: ${{ steps.check.outputs.shards }}
      should_sync: ${{ steps.check.outputs.should_sync }}
    steps:
      - name: Get Current Week
        id: check
        run: |
          RESPONSE=$(curl -s -X POST "$EDGE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            --max-time 15 \
            -d '{"action": "getCurrentWeek"}')
          
          echo "ğŸ“¡ $RESPONSE"
          
          WEEK=$(echo "$RESPONSE" | jq -r '.week // empty')
          
          if [ -n "${{ github.event.inputs.week }}" ]; then
            WEEK="${{ github.event.inputs.week }}"
          fi
          
          SHARDS="${{ github.event.inputs.total_shards || '5' }}"
          
          if [ -z "$WEEK" ] || [ "$WEEK" = "Pre-Season" ]; then
            echo "â¸ï¸ Pre-Season. Skipping."
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Week: $WEEK | Shards: $SHARDS"
            echo "should_sync=true" >> $GITHUB_OUTPUT
          fi
          
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "shards=$SHARDS" >> $GITHUB_OUTPUT

  sync-shard:
    name: ğŸ”„ Shard ${{ matrix.shard }}/5
    needs: pre-sync
    if: needs.pre-sync.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [0, 1, 2, 3, 4]
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Sync Shard ${{ matrix.shard }}
        run: |
          WEEK="${{ needs.pre-sync.outputs.current_week }}"
          SHARD=${{ matrix.shard }}
          SHARDS=${{ needs.pre-sync.outputs.total_shards }}
          
          echo "ğŸ”„ Shard $SHARD/$SHARDS â€” $WEEK"
          
          RESPONSE=$(curl -s -X POST "$EDGE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            --max-time 120 \
            -d "{
              \"action\": \"initiateFairSyncShard\",
              \"adminKey\": \"$SYNC_ADMIN_KEY\",
              \"week\": \"$WEEK\",
              \"shard\": $SHARD,
              \"totalShards\": $SHARDS
            }")
          
          echo "ğŸ“¡ Response: $RESPONSE"
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          COMPLETED=$(echo "$RESPONSE" | jq -r '.completed // 0')
          FAILED=$(echo "$RESPONSE" | jq -r '.failed // 0')
          AGENTS=$(echo "$RESPONSE" | jq -r '.agentsInShard // 0')
          
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ Shard $SHARD Results          "
          echo "â”‚ Agents in shard: $AGENTS      "
          echo "â”‚ âœ… Completed:    $COMPLETED   "
          echo "â”‚ âŒ Failed:       $FAILED      "
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ FAILED"
            exit 1
          fi

  aggregate:
    name: ğŸ“Š Aggregate
    needs: [pre-sync, sync-shard]
    if: always() && needs.pre-sync.outputs.should_sync == 'true' && needs.sync-shard.result != 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DB
        run: sleep 3

      - name: Run Aggregations
        run: |
          WEEK="${{ needs.pre-sync.outputs.current_week }}"
          echo "ğŸ“Š Aggregating $WEEK..."
          
          RESPONSE=$(curl -s -X POST "$EDGE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            --max-time 60 \
            -d "{
              \"action\": \"runAggregationOnly\",
              \"adminKey\": \"$SYNC_ADMIN_KEY\",
              \"week\": \"$WEEK\"
            }")
          
          echo "$RESPONSE"
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… Aggregations done!"
          else
            echo "âš ï¸ Aggregation issue"
          fi

  cleanup:
    name: ğŸ§¹ Cleanup
    needs: [pre-sync, aggregate]
    if: always() && needs.pre-sync.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Remove Stale Users
        run: |
          RESPONSE=$(curl -s -X POST "$EDGE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            --max-time 15 \
            -d '{"action": "cleanupOnlineUsers"}')
          
          echo "ğŸ§¹ Removed $(echo "$RESPONSE" | jq -r '.removed // 0') stale users"

  summary:
    name: ğŸ“‹ Summary
    needs: [pre-sync, sync-shard, aggregate, cleanup]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Final Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       âš¡ BTS MISSION SYNC REPORT          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ ğŸ“… Week:        ${{ needs.pre-sync.outputs.current_week }}"
          echo "â•‘ ğŸ”€ Shards:      ${{ needs.pre-sync.outputs.total_shards }}"
          echo "â•‘ ğŸ”„ Sync:        ${{ needs.sync-shard.result }}"
          echo "â•‘ ğŸ“Š Aggregation: ${{ needs.aggregate.result }}"
          echo "â•‘ ğŸ§¹ Cleanup:     ${{ needs.cleanup.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ needs.sync-shard.result }}" = "success" ]; then
            echo "ğŸ‰ All 200 agents synced!"
          else
            echo "âš ï¸ Check shard logs"
          fi
