name: âš¡ BTS Mission Hourly Sync

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      week:
        description: 'Week (leave empty for auto)'
        required: false
        default: ''

jobs:
  sync:
    name: ğŸ”„ Full Sync
    runs-on: ubuntu-latest
    steps:
      - name: Get Week
        id: week
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          RESP=$(curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"getCurrentWeek"}')
          WEEK=$(echo "$RESP" | jq -r '.week // "Week 10"')
          if [ -n "${{ github.event.inputs.week }}" ]; then 
            WEEK="${{ github.event.inputs.week }}"
          fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "ğŸ“… Week: $WEEK"

      - name: Sync All Agents
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ steps.week.outputs.week }}
        run: |
          echo "ğŸ”„ Starting sync for $WEEK"
          
          # Run 5 batches sequentially (not parallel)
          for BATCH in 1 2 3 4 5; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Batch $BATCH/5"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            RESP=$(curl -s -X POST "$EDGE_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $ANON_KEY" \
              -H "apikey: $ANON_KEY" \
              --max-time 120 \
              -d "{\"action\":\"initiateFairSync\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\"}")
            
            echo "$RESP" | jq -r '"âœ… Synced: \(.progress.completed // 0) | âŒ Failed: \(.progress.failed // 0)"'
            
            # Small delay between batches
            sleep 2
          done
          
          echo ""
          echo "ğŸ‰ All batches complete!"

      - name: Final Aggregation
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ steps.week.outputs.week }}
        run: |
          echo "ğŸ“Š Running final aggregation..."
          curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d "{\"action\":\"runAggregationOnly\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\"}"
          echo ""
          echo "âœ… Aggregation complete!"

      - name: Cleanup
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"cleanupOnlineUsers"}'
          echo "ğŸ§¹ Cleanup done!"
