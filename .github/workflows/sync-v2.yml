name: ‚ö° BTS Mission Hourly Sync (Debug)

on:
  workflow_dispatch:
    inputs:
      week:
        description: 'Week (leave empty for auto)'
        required: false
        default: ''

jobs:
  debug:
    name: üîß Debug All
    runs-on: ubuntu-latest
    steps:
      - name: 1Ô∏è‚É£ Check Secrets Exist
        run: |
          echo "============================================"
          echo "CHECKING SECRETS"
          echo "============================================"
          
          if [ -z "${{ secrets.SUPABASE_ANON_KEY }}" ]; then
            echo "‚ùå SUPABASE_ANON_KEY is EMPTY or NOT SET!"
          else
            echo "‚úÖ SUPABASE_ANON_KEY exists (length: ${#ANON_KEY_CHECK})"
          fi
          
          if [ -z "${{ secrets.SYNC_ADMIN_KEY }}" ]; then
            echo "‚ùå SYNC_ADMIN_KEY is EMPTY or NOT SET!"
          else
            echo "‚úÖ SYNC_ADMIN_KEY exists"
          fi
        env:
          ANON_KEY_CHECK: ${{ secrets.SUPABASE_ANON_KEY }}

      - name: 2Ô∏è‚É£ Test Basic API (No Auth)
        run: |
          echo "============================================"
          echo "TEST 1: Basic API call without auth"
          echo "============================================"
          
          RESP=$(curl -s -w "\n\nHTTP_CODE:%{http_code}" -X POST \
            "https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -d '{"action":"getCurrentWeek"}')
          
          echo "Response:"
          echo "$RESP"
          echo ""

      - name: 3Ô∏è‚É£ Test API With Auth
        env:
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "============================================"
          echo "TEST 2: API call WITH auth header"
          echo "============================================"
          
          echo "ANON_KEY first 20 chars: ${ANON_KEY:0:20}..."
          echo ""
          
          RESP=$(curl -s -w "\n\nHTTP_CODE:%{http_code}" -X POST \
            "https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"getCurrentWeek"}')
          
          echo "Response:"
          echo "$RESP"
          echo ""

      - name: 4Ô∏è‚É£ Test getCurrentWeek
        env:
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "============================================"
          echo "TEST 3: getCurrentWeek"
          echo "============================================"
          
          RESP=$(curl -s -X POST \
            "https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"getCurrentWeek"}')
          
          echo "Raw response: $RESP"
          echo ""
          
          WEEK=$(echo "$RESP" | jq -r '.week // "PARSE_ERROR"')
          echo "Parsed week: $WEEK"

      - name: 5Ô∏è‚É£ Test initiateFairSyncShard
        env:
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
        run: |
          echo "============================================"
          echo "TEST 4: initiateFairSyncShard (Shard 0)"
          echo "============================================"
          
          WEEK="${{ github.event.inputs.week }}"
          if [ -z "$WEEK" ]; then
            WEEK="Week 10"
          fi
          
          echo "Week: $WEEK"
          echo "Admin Key first 5 chars: ${ADMIN_KEY:0:5}..."
          echo ""
          
          # Build JSON manually
          JSON="{\"action\":\"initiateFairSyncShard\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\",\"shard\":0,\"totalShards\":5}"
          echo "Request JSON: $JSON"
          echo ""
          
          RESP=$(curl -s -w "\n\nHTTP_CODE:%{http_code}" -X POST \
            "https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "apikey: $ANON_KEY" \
            --max-time 120 \
            -d "$JSON")
          
          echo "Response:"
          echo "$RESP"
          echo ""
          
          # Try to parse
          echo "Parsed:"
          echo "$RESP" | head -n -2 | jq . 2>/dev/null || echo "(Could not parse as JSON)"

      - name: 6Ô∏è‚É£ Test with Hardcoded Key (TEMPORARY DEBUG)
        run: |
          echo "============================================"
          echo "TEST 5: Direct call with your actual anon key"
          echo "============================================"
          echo ""
          echo "‚ö†Ô∏è This test uses NO secrets - just tests if API is reachable"
          echo ""
          
          # Test without any auth first
          RESP=$(curl -s -X POST \
            "https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -d '{"action":"getCurrentWeek"}')
          
          echo "No-auth response: $RESP"

      - name: 7Ô∏è‚É£ Debug Summary
        run: |
          echo ""
          echo "============================================"
          echo "üìã DEBUG COMPLETE"
          echo "============================================"
          echo ""
          echo "Check the outputs above for:"
          echo "  1. Are secrets set? (Step 1)"
          echo "  2. Does API work without auth? (Step 2)"
          echo "  3. Does API work with auth? (Step 3)"
          echo "  4. Does getCurrentWeek return valid week? (Step 4)"
          echo "  5. Does initiateFairSyncShard work? (Step 5)"
          echo ""
          echo "If Step 2 works but Step 3 fails ‚Üí Secret is wrong"
          echo "If Step 3 works but Step 5 fails ‚Üí ADMIN_KEY is wrong"
          echo "If all fail ‚Üí API URL or function issue"
