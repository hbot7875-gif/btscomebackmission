name: âš¡ BTS Mission Hourly Sync (Safe)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      week:
        description: 'Week label'
        required: false
        default: ''

jobs:
  sync:
    name: ğŸ”„ Safe Sync
    runs-on: ubuntu-latest
    steps:
      - name: Get Week
        id: week
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          RESP=$(curl -s --max-time 15 -X POST "$EDGE_URL" -H "apikey: $ANON_KEY" -d '{"action":"getCurrentWeek"}')
          WEEK=$(echo "$RESP" | jq -r '.week // "Week 10"')
          if [ -n "${{ github.event.inputs.week }}" ]; then WEEK="${{ github.event.inputs.week }}"; fi
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "ğŸ“… Syncing Week: $WEEK"

      - name: Run Shards Sequentially
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ steps.week.outputs.week }}
        run: |
          TOTAL_OK=0
          TOTAL_FAIL=0
          
          for SHARD in 0 1 2 3 4; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”„ Syncing Shard $SHARD/5"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            RESP=$(curl -s --max-time 55 -X POST "$EDGE_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $ANON_KEY" \
              -H "apikey: $ANON_KEY" \
              -d "{\"action\":\"initiateFairSyncShard\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\",\"shard\":$SHARD,\"totalShards\":5}")
            
            echo "$RESP" | jq .
            
            # Track results
            OK=$(echo "$RESP" | jq -r '.completed // 0')
            FAIL=$(echo "$RESP" | jq -r '.failed // 0')
            TOTAL_OK=$((TOTAL_OK + OK))
            TOTAL_FAIL=$((TOTAL_FAIL + FAIL))
            
            echo "âœ… Shard $SHARD: $OK synced, $FAIL failed"
            
            sleep 2
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š TOTAL: $TOTAL_OK synced, $TOTAL_FAIL failed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Final Aggregation
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ steps.week.outputs.week }}
        run: |
          echo "ğŸ“Š Aggregating Results..."
          curl -s --max-time 30 -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d "{\"action\":\"runAggregationOnly\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\"}" | jq .
          echo "âœ… Done"

      - name: Cleanup
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -s --max-time 10 -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"cleanupOnlineUsers"}' | jq .
