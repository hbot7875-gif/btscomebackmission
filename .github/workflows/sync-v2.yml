name: âš¡ BTS Mission Hourly Sync

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      week:
        description: 'Week (leave empty for auto)'
        required: false
        default: ''

jobs:
  pre-sync:
    name: ğŸ” Check Week
    runs-on: ubuntu-latest
    outputs:
      week: ${{ steps.get.outputs.week }}
      sync: ${{ steps.get.outputs.sync }}
    steps:
      - name: Get Current Week
        id: get
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          RESP=$(curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"getCurrentWeek"}')
          
          echo "Response: $RESP"
          WEEK=$(echo "$RESP" | jq -r '.week // "Pre-Season"')
          
          if [ -n "${{ github.event.inputs.week }}" ]; then 
            WEEK="${{ github.event.inputs.week }}"
          fi
          
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          
          if [ "$WEEK" = "Pre-Season" ] || [ "$WEEK" = "null" ]; then 
            echo "sync=false" >> $GITHUB_OUTPUT
          else 
            echo "sync=true" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ“… Week: $WEEK"

  shard:
    name: ğŸ”„ Shard ${{ matrix.s }}
    needs: pre-sync
    if: needs.pre-sync.outputs.sync == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        s: [0, 1, 2, 3, 4]
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Sync Shard ${{ matrix.s }}
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ needs.pre-sync.outputs.week }}
          SHARD: ${{ matrix.s }}
        run: |
          echo "ğŸ”„ Shard $SHARD for $WEEK"
          
          RESP=$(curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            --max-time 120 \
            -d "{\"action\":\"initiateFairSyncShard\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\",\"shard\":$SHARD,\"totalShards\":5}")
          
          echo "$RESP" | jq . || echo "$RESP"
          
          SUCCESS=$(echo "$RESP" | jq -r '.success // false')
          DONE=$(echo "$RESP" | jq -r '.completed // 0')
          AGENTS=$(echo "$RESP" | jq -r '.agentsInShard // 0')
          
          echo "âœ… Shard $SHARD: $DONE/$AGENTS agents"
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ Failed!"
            exit 1
          fi

  aggregate:
    name: ğŸ“Š Aggregate
    needs: [pre-sync, shard]
    if: always() && needs.pre-sync.outputs.sync == 'true' && needs.shard.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Run Aggregations
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ADMIN_KEY: ${{ secrets.SYNC_ADMIN_KEY }}
          WEEK: ${{ needs.pre-sync.outputs.week }}
        run: |
          sleep 3
          RESP=$(curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d "{\"action\":\"runAggregationOnly\",\"adminKey\":\"$ADMIN_KEY\",\"week\":\"$WEEK\"}")
          
          echo "$RESP"
          echo "âœ… Aggregation done"

  cleanup:
    name: ğŸ§¹ Cleanup
    needs: [pre-sync, aggregate]
    if: always() && needs.pre-sync.outputs.sync == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Stale Users
        env:
          EDGE_URL: https://uspezooqcdrwaqxcqojn.supabase.co/functions/v1/spy-battle-api
          ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -s -X POST "$EDGE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ANON_KEY" \
            -H "apikey: $ANON_KEY" \
            -d '{"action":"cleanupOnlineUsers"}'
          echo "âœ… Cleanup done"

  summary:
    name: ğŸ“‹ Summary
    needs: [pre-sync, shard, aggregate, cleanup]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Print Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     âš¡ SYNC COMPLETE                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Week:   ${{ needs.pre-sync.outputs.week }}"
          echo "â•‘ Shards: ${{ needs.shard.result }}"
          echo "â•‘ Agg:    ${{ needs.aggregate.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
