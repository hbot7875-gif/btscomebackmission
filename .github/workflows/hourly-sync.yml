name: âš¡ BTS Mission Hourly Sync

on:
  schedule:
    - cron: '5 */2 * * *'
  workflow_dispatch:

jobs:
  fair-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ• Shard 0
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":0,"totalShards":6}')
          echo "Shard 0: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 0: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 0 done"
          sleep 3

      - name: ðŸ• Shard 1
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":1,"totalShards":6}')
          echo "Shard 1: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 1: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 1 done"
          sleep 3

      - name: ðŸ• Shard 2
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":2,"totalShards":6}')
          echo "Shard 2: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 2: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 2 done"
          sleep 3

      - name: ðŸ• Shard 3
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":3,"totalShards":6}')
          echo "Shard 3: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 3: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 3 done"
          sleep 3

      - name: ðŸ• Shard 4
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":4,"totalShards":6}')
          echo "Shard 4: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 4: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 4 done"
          sleep 3

      - name: ðŸ• Shard 5
        run: |
          RESPONSE=$(curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":5,"totalShards":6}')
          echo "Shard 5: $RESPONSE"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'âœ… Shard 5: {d.get(\"completed\",0)}/{d.get(\"agentsInShard\",0)} synced, {d.get(\"failed\",0)} failed, {d.get(\"duration\",\"?\")}') " 2>/dev/null || echo "âœ… Shard 5 done"
          sleep 3

      - name: ðŸ“Š Aggregation
        run: |
          curl -s --max-time 30 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"runAggregationOnly","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}"}'
          echo "âœ… Aggregation done"

      - name: ðŸ§¹ Cleanup
        run: |
          curl -s --max-time 15 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"cleanupOnlineUsers"}'
          echo "âœ… Cleanup done"

      - name: âœ… Summary
        run: echo "ðŸŽ‰ All shards completed at $(date)"
