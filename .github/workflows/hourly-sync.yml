name: ‚ö° BTS Mission Hourly Sync

on:
  schedule:
    - cron: '5 */2 * * *'
  workflow_dispatch:

jobs:
  fair-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üïê Shard 0 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":0,"totalShards":6}'
          echo "‚úÖ Shard 0 done"
          sleep 3

      - name: üïê Shard 1 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":1,"totalShards":6}'
          echo "‚úÖ Shard 1 done"
          sleep 3

      - name: üïê Shard 2 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":2,"totalShards":6}'
          echo "‚úÖ Shard 2 done"
          sleep 3

      - name: üïê Shard 3 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":3,"totalShards":6}'
          echo "‚úÖ Shard 3 done"
          sleep 3

      - name: üïê Shard 4 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":4,"totalShards":6}'
          echo "‚úÖ Shard 4 done"
          sleep 3

      - name: üïê Shard 5 of 6
        run: |
          curl -s --max-time 55 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"initiateFairSyncShard","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}","shard":5,"totalShards":6}'
          echo "‚úÖ Shard 5 done"
          sleep 3

      - name: üìä Final Aggregation
        run: |
          curl -s --max-time 30 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"runAggregationOnly","adminKey":"${{ secrets.SYNC_ADMIN_KEY }}"}'
          echo "‚úÖ Aggregation done"

      - name: üßπ Cleanup
        run: |
          curl -s --max-time 15 -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/spy-battle-api" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"action":"cleanupOnlineUsers"}'
          echo "‚úÖ Cleanup done"

      - name: ‚úÖ Complete
        run: echo "üéâ All 170 agents synced at $(date)"
